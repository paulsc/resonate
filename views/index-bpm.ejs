<html>
<head>
<title> Tracker </title>

<style>
body { 
    font-family: "Arial"; 
    font-size: 100px;
    font-weight: bold;
}
</style>

<script type="text/javascript" src="/underscore.js"></script>

<!--
<script src="//ajax.googleapis.com/ajax/libs/jquerymobile/1.4.3/jquery.mobile.min.js"></script>
-->

<script type="text/javascript">

    var socket;
    var color = Math.random();
    var color255 = Math.round(color * 255);

    var MAX_RECORDING_LENGTH = 50;
    var MIN_BPM = 70;
    var MAX_BPM = 180;
    var MIN_SENSITIVITY = 80;
    var TOLERANCE = 0.80; // 20% tolerance to find value
    var MIN_SPREAD = 5;
    var bpmTarget = 120;

    function getBPM(input, samplingInterval) {

        if (input.length < 2) return { values: [], bpm: 0 };

        var valueAboveOne = false;
        for (i = 0; i < input.length; i++) {
            if (input[i] > 1) {
                valueAboveOne = true;
                break;
            }
        }

        if (!valueAboveOne) return { values: [], bpm: 0 };

        var spread = _.max(input) - _.min(input);
        if (spread < MIN_SPREAD) return { values: [], bpm: 0 };

        var autoCorrel = function(values, period) {
            var result = 0;
            for (var i = 0; i < values.length; i++) {
                result += values[i] * values[(i + period) % values.length];
            }
            return result;
        }

        var valuesWithIndex = [];
        var max = -1;
        for (var i = 1; i < input.length / 2; i++) {
            var correlValue = autoCorrel(input, i);
            valuesWithIndex.push({ value: correlValue, index: i });
            if (correlValue > max) max = correlValue;
        }

        var lowerThreshold = max * TOLERANCE;
 
        var candidates = _.select(valuesWithIndex, function(item) {
            return item.value > lowerThreshold;
        });
 
        var maxPeriod = 60 / MIN_BPM / samplingInterval;
        var minPeriod = 60 / MAX_BPM / samplingInterval;
        var candidatesInRange = _.select(candidates, function(item) {
            return item.index > minPeriod && item.index < maxPeriod;
        });

        var strongCandidates = _.select(candidatesInRange, function(item) {
                return item.value > MIN_SENSITIVITY;
        });

        if (strongCandidates.length == 0) {
            return { values: candidates, bpm: '?' };
        }
 
        var selected = _.max(strongCandidates, function(item) {
            return item.value;
        });

        // try to find pattern at double speed
        var floor = Math.floor(selected.index / 2);
        var ceil = Math.ceil(selected.index / 2);

        var doubleSpeed;
        _.each(strongCandidates, function(item) {
            if (item.index == floor && item.value > (selected.value * 0.80)) {
                doubleSpeed = item;
            }
            else if (item.index == ceil && item.value > (selected.value * 0.80)) {
                doubleSpeed = item;
            }
        });

        if (doubleSpeed) selected = doubleSpeed;

        var bpm = Math.round(60 / (selected.index * samplingInterval));

        var ordered = _.sortBy(valuesWithIndex, function(item) { return item.value });
        var debug = ordered.slice(ordered.length-5, ordered.length);
 
        return { values: ordered, bpm: bpm, strength: selected.value };
    }

    function HSVtoRGB(h, s, v) {
        var r, g, b, i, f, p, q, t;
        if (h && s === undefined && v === undefined) {
            s = h.s, v = h.v, h = h.h;
        }
        i = Math.floor(h * 6);
        f = h * 6 - i;
        p = v * (1 - s);
        q = v * (1 - f * s);
        t = v * (1 - (1 - f) * s);
        switch (i % 6) {
            case 0: r = v, g = t, b = p; break;
            case 1: r = q, g = v, b = p; break;
            case 2: r = p, g = v, b = t; break;
            case 3: r = p, g = q, b = v; break;
            case 4: r = t, g = p, b = v; break;
            case 5: r = v, g = p, b = q; break;
        }
        return {
           r: Math.floor(r * 255),
           g: Math.floor(g * 255),
           b: Math.floor(b * 255)
        };
    }

    var aggregatedMovement = 0;
    var sampleCount = 0;

    function socketOpened() {
        document.getElementById("log").innerHTML = 'connected.';
    }

    function socketClosed() {
        document.getElementById("log").innerHTML = 'disconnected.';  
    }

    function onload() {

        var bg = HSVtoRGB(color, 1, 1);

        document.body.style.backgroundColor = "rgb(" + bg.r + ", " + bg.g + ", " + bg.b + ")";

        var recording = new Array();

        var deviceMotionHandler = function(event) {
            var summed = 0;
            summed += Math.abs(event.acceleration.x);
            summed += Math.abs(event.acceleration.y);
            summed += Math.abs(event.acceleration.z);

            recording.push(summed);
            if (recording.length > MAX_RECORDING_LENGTH) recording.shift();

            var result = getBPM(recording, event.interval);

            /*if (result.bpm < 100 && result.bpm > 10) {
                window.removeEventListener('devicemotion', deviceMotionHandler);
            }*/

            if (result.bpm == '?') return;

            document.getElementById("accel").innerHTML = 'n2BPM: ' + result.bpm + '<br/>';
            /*_.each(result.values, function(item) {
                document.getElementById("accel").innerHTML += 
                    Math.round(item.value) + ' ' + item.index + '<br/>';
            });*/

            if (socket && socket.readyState == 1) {
                socket.send(color255 + "|" + summed + "|" + result.bpm);
                /*
                var limited = result.values.slice(result.values.length-20, result.values.length);
                var debugString = _.map(limited, function(item) {
                    return Math.round(item.value) + ":" + item.index;
                 });
                socket.send(result.bpm + " | " + debugString.join(" "));
                */

                //socket.send(Math.round(summed * 10) / 10 + " " + result.bpm + " " + Math.round(result.strength));
            }
        }

        var recordingAlpha = new Array();
        var recordingBeta = new Array();
        var recordingGamma = new Array();
    
        var previousEventTime = 0;
        var intervals = new Array();

        var deviceOrientationHandler = function(event) {
            // alpha: (0, 360) phone flat on table turn like compass
            // beta: (-90, 90) phone flat on table -> 0, move camera up to reach +90
            // gamma: (-180, 180) phone flat on table = 0, face down is 180 and -180
            alpha = Math.round(event.alpha);
            recordingAlpha.push(alpha);
            if (recordingAlpha.length > MAX_RECORDING_LENGTH) recordingAlpha.shift();

            beta = Math.round(event.beta);
            recordingBeta.push(beta);
            if (recordingBeta.length > MAX_RECORDING_LENGTH) recordingBeta.shift();

            gamma = Math.round(event.gamma);
            recordingGamma.push(gamma);
            if (recordingGamma.length > MAX_RECORDING_LENGTH) recordingGamma.shift();

            var now = new Date().getTime();

            if (previousEventTime == 0) {
                previousEventTime = now;
                return;
            }

            var interval = now - previousEventTime; 
            previousEventTime = now;
            intervals.push(interval);
            if (intervals.length > MAX_RECORDING_LENGTH) intervals.shift();

            var intervalSum = intervals.reduce(function(a, b) { return a + b; });
            var intervalAvg = intervalSum / intervals.length / 1000;

            var bpmAlpha = getBPM(recordingAlpha, intervalAvg).bpm;
            var bpmBeta = getBPM(recordingBeta, intervalAvg).bpm;
            var bpmGamma = getBPM(recordingGamma, intervalAvg).bpm;

            document.getElementById("log-b").innerHTML = 
                "<br/>orientation<br/>" + bpmAlpha + "-" + alpha + "<br/>" + 
                bpmBeta + '-' + beta + "<br/>" + bpmGamma + '-' + gamma;
        };

        if (window.DeviceOrientationEvent) {
            //window.addEventListener("deviceorientation", deviceOrientationHandler, true);
        }

        window.addEventListener('devicemotion', deviceMotionHandler);
        var on = true;
        document.addEventListener('touchstart', function(e) {
            /*
            if (socket && socket.readyState == 1) {
                socket.send(recordingBeta);
            }

            document.getElementById("log-c").innerHTML = "SENT";
            window.removeEventListener("deviceorientation", deviceOrientationHandler, true);
            return;

            if (on) {
                window.removeEventListener('devicemotion', deviceMotionHandler);
                on = false;
            }
            else {
                window.addEventListener('devicemotion', deviceMotionHandler);
                on = true;
            }
            */
        }, false);

        socket = new WebSocket('<%= websocket_url %>');
        socket.onopen = socketOpened;
        socket.onclose = socketClosed;
    };

</script>

</head>

<body onload="onload()">

    <div id="log"></div>
    <div id="accel-x"></div>
    <div id="sample-count"></div>
    <div id="accel"></div>
    <div id="log-b"></div>
    <div id="log-c"></div>

</body>
</html>

